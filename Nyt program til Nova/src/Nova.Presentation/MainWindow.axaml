<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Nova.Presentation.ViewModels"
        xmlns:views="using:Nova.Presentation.Views"
        x:Class="Nova.Presentation.MainWindow"
        x:DataType="vm:MainViewModel"
        Title="Nova System Manager"
        MinWidth="1200" MinHeight="700"
        Width="1400" Height="800"
        WindowStartupLocation="CenterScreen">

    <Design.DataContext>
        <vm:MainViewModel />
    </Design.DataContext>

    <!-- === KEYBOARD SHORTCUTS === -->
    <Window.KeyBindings>
      <!-- Existing shortcuts -->
      <KeyBinding Gesture="Ctrl+R" Command="{Binding RefreshPortsCommand}" />
      <KeyBinding Gesture="F5" Command="{Binding DownloadBankCommand}" />
      <KeyBinding Gesture="Ctrl+D" Command="{Binding DownloadBankCommand}" />
      
      <!-- New shortcuts (v1.0) -->
      <KeyBinding Gesture="Ctrl+S" Command="{Binding SavePresetCommand}" />
      <KeyBinding Gesture="Ctrl+Z" Command="{Binding UndoCommand}" />
      <KeyBinding Gesture="Ctrl+Y" Command="{Binding RedoCommand}" />
      <KeyBinding Gesture="Ctrl+C" Command="{Binding CopyPresetCommand}" />
    </Window.KeyBindings>

    <Grid>
        <DockPanel Margin="{StaticResource SpacingMedium}">
        <!-- Toolbar at Top -->
        <Border DockPanel.Dock="Top"
                Background="{StaticResource BackgroundSecondary}"
                Padding="{StaticResource SpacingSmall}"
                CornerRadius="{StaticResource BorderRadiusMedium}"
                Margin="0,0,0,16">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0"
                           Text="Nova System Manager"
                           FontSize="{StaticResource FontSizeLarge}"
                           FontWeight="{StaticResource FontWeightBold}"
                           Foreground="{StaticResource TextPrimary}"
                           VerticalAlignment="Center" />
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding ToggleThemeCommand}"
                            ToolTip.Tip="Toggle Dark/Light theme (Ctrl+T)"
                            Width="40"
                            Height="32"
                            Padding="8"
                            AutomationProperties.Name="Toggle theme"
                            AutomationProperties.HelpText="Switch between light and dark mode">
                        <PathIcon Width="16" Height="16">
                            <PathIcon.Data>
                                <!-- Moon icon -->
                                M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z
                            </PathIcon.Data>
                        </PathIcon>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Status Bar at Bottom -->
        <Border DockPanel.Dock="Bottom" 
                Background="{StaticResource BackgroundPrimary}" 
                Padding="{StaticResource SpacingSmall}" 
                CornerRadius="{StaticResource BorderRadiusMedium}"
                Margin="0,16,0,0">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="{Binding StatusMessage}" 
                           Foreground="{StaticResource TextSecondary}"
                           VerticalAlignment="Center"
                           AutomationProperties.LiveSetting="Polite"
                           AutomationProperties.Name="Status message" />
                <ProgressBar Grid.Column="1" 
                             Value="{Binding DownloadProgress}"
                             Width="100"
                             Height="4"
                             IsVisible="{Binding IsDownloading}"
                             VerticalAlignment="Center"
                             Margin="16,0,0,0"
                             AutomationProperties.Name="Download progress" />
            </Grid>
        </Border>

        <!-- Main Content with Tab Control -->
        <TabControl>
            <!-- Connection Tab -->
            <TabItem Header="Connection"
                     AutomationProperties.Name="Connection and MIDI settings tab">
                <Grid ColumnDefinitions="*,16,400" RowDefinitions="*">
                    <!-- Left Side: Connection, Bank Operations, and Preset List -->
                    <StackPanel Grid.Column="0" Spacing="16">
                        <!-- Connection Section -->
                        <Border Background="{StaticResource BackgroundSecondary}" 
                                Padding="{StaticResource CardPadding}" 
                                CornerRadius="{StaticResource BorderRadiusLarge}">
                            <StackPanel Spacing="{StaticResource Spacing16}">
                                <TextBlock Text="MIDI Connection" 
                                           FontWeight="{StaticResource FontWeightBold}" 
                                           FontSize="{StaticResource FontSizeLarge}"
                                           Foreground="{StaticResource TextPrimary}"/>
                                
                                <Grid ColumnDefinitions="*,Auto,Auto" RowDefinitions="Auto">
                                    <ComboBox ItemsSource="{Binding AvailablePorts}"
                                              SelectedItem="{Binding SelectedPort}"
                                              PlaceholderText="Select MIDI Port..."
                                              HorizontalAlignment="Stretch"
                                              AutomationProperties.Name="MIDI port selection"
                                              AutomationProperties.HelpText="Choose a MIDI port to connect to the Nova System pedal"/>
                                    
                                    <Button Grid.Column="1" 
                                            Command="{Binding RefreshPortsCommand}"
                                            ToolTip.Tip="Refresh available MIDI ports (Ctrl+R)"
                                            Margin="8,0,0,0"
                                            Width="32"
                                            Height="32"
                                            Padding="6"
                                            AutomationProperties.Name="Refresh MIDI ports"
                                            AutomationProperties.HelpText="Scan for available MIDI devices">
                                        <PathIcon Width="20" Height="20">
                                            <PathIcon.Data>
                                                <!-- Refresh/Reload icon -->
                                                M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z
                                            </PathIcon.Data>
                                        </PathIcon>
                                    </Button>
                                    
                                    <Button Grid.Column="2"
                                            Content="Connect"
                                            Command="{Binding ConnectCommand}"
                                            Margin="8,0,0,0"
                                            Width="100"
                                            AutomationProperties.Name="Connect to MIDI device"
                                            AutomationProperties.HelpText="Establishes connection to selected MIDI port" />
                                </Grid>
                                
                                <!-- Connected Status -->
                                <StackPanel Orientation="Horizontal" 
                                            Spacing="8" 
                                            IsVisible="{Binding IsConnected}">
                                    <Ellipse Width="12" 
                                             Height="12" 
                                             Fill="{StaticResource StatusConnected}"
                                             VerticalAlignment="Center" />
                                    <TextBlock Text="Connected" 
                                               Foreground="{StaticResource StatusConnected}"
                                               FontWeight="{StaticResource FontWeightSemiBold}"
                                               VerticalAlignment="Center"
                                               AutomationProperties.LiveSetting="Polite" />
                                </StackPanel>
                                
                                <!-- Disconnected Status -->
                                <StackPanel Orientation="Horizontal" 
                                            Spacing="8" 
                                            IsVisible="{Binding !IsConnected}">
                                    <Ellipse Width="12" 
                                             Height="12" 
                                             Fill="{StaticResource StatusDisconnected}"
                                             VerticalAlignment="Center" />
                                    <TextBlock Text="Disconnected" 
                                               Foreground="{StaticResource TextSecondary}"
                                               VerticalAlignment="Center"
                                               AutomationProperties.LiveSetting="Polite" />
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Bank Operations Section -->
                        <Border Background="{StaticResource BackgroundSecondary}" 
                                Padding="{StaticResource CardPadding}" 
                                CornerRadius="{StaticResource BorderRadiusLarge}">
                            <StackPanel Spacing="{StaticResource Spacing16}">
                                <TextBlock Text="User Bank" 
                                           FontWeight="{StaticResource FontWeightBold}" 
                                           FontSize="{StaticResource FontSizeLarge}"
                                           Foreground="{StaticResource TextPrimary}"/>
                                
                                <TextBlock Text="Trigger 'Send Dump' from your Nova System pedal (UTILITY → MIDI → Send Dump)"
                                           Foreground="{StaticResource TextTertiary}"
                                           TextWrapping="Wrap"/>
                                
                                <Button Content="Download User Bank"
                                        Command="{Binding DownloadBankCommand}"
                                        HorizontalAlignment="Left"
                                        Padding="{StaticResource ButtonPadding}"
                                        ToolTip.Tip="Download all 60 presets from pedal (F5 or Ctrl+D)"
                                        AutomationProperties.Name="Download user bank"
                                        AutomationProperties.HelpText="Downloads all 60 presets from the Nova System pedal (F5 or Ctrl+D)" />
                            </StackPanel>
                        </Border>
                        
                        <!-- Preset List View -->
                        <views:PresetListView DataContext="{Binding PresetList}" />
                    </StackPanel>
                    
                    <!-- Right Side: Preset Detail View -->
                    <views:PresetDetailView Grid.Column="2" 
                                            DataContext="{Binding PresetDetail}" />
                </Grid>
            </TabItem>

            <!-- File Manager Tab -->
            <TabItem Header="File Manager"
                     AutomationProperties.Name="File management tab">
                <views:FileManagerView DataContext="{Binding FileManager}" />
            </TabItem>

            <!-- System Settings Tab -->
            <TabItem Header="System Settings"
                     AutomationProperties.Name="System configuration tab">
                <views:SystemSettingsView DataContext="{Binding SystemSettings}" />
            </TabItem>

            <!-- MIDI Mapping Tab -->
            <TabItem Header="MIDI Mapping"
                     AutomationProperties.Name="MIDI mapping tab">
                <views:MidiMappingView DataContext="{Binding CcMapping}" />
            </TabItem>
        </TabControl>
    </DockPanel>
    
    <!-- Loading Overlay -->
    <Border Background="#CC000000"
            IsVisible="{Binding IsDownloading}"
            ZIndex="999">
        <StackPanel VerticalAlignment="Center" 
                    HorizontalAlignment="Center"
                    Spacing="16">
            <ProgressBar IsIndeterminate="True"
                        Width="300"
                        Height="4"
                        Foreground="{StaticResource AccentPrimary}"/>
            <TextBlock Text="{Binding StatusMessage}"
                      Foreground="White"
                      FontSize="{StaticResource FontSizeLarge}"
                      FontWeight="{StaticResource FontWeightSemiBold}"
                      HorizontalAlignment="Center"
                      AutomationProperties.LiveSetting="Polite"/>
        </StackPanel>
    </Border>
</Grid>
</Window>
